##Distinct EE_ID that have taken STD from 2018-end 2019
SELECT 
count(distinct EE_ID_from_Master)
FROM [dbo].[Sedgwick_Juris] as J
where Coverage_Code IN ('SD')
    and Claim_Sub_Status <> 'Denied'
    and Date_Disability_Benefits_Begin <> 'NULL'
    and Date_Disability_Benefits_Begin > '2017-12-31'
    and Date_Disability_Benefits_Begin < '2019-12-31'
   and ee_id_from_master NOT IN ('202000000000000','30193583887-0001',  '30193595858-0001', '30193585756-0001', '30193661310-0001', '30193357331-0001') 
    and Last_Updated_Date = (Select Max((Last_Updated_Date ))
    from [dbo].[Sedgwick_Juris] WHERE j.file_number = file_number);

##code to pull all fields related to STD taken within same time period

SELECT
DISTINCT EE_ID_from_Master,
Coverage_Code,
Benefit_Plan_Description,
sum(duration) OVER (PARTITION BY EE_ID_FROM_MASTER) AS TOT_DURATION,
max(max_claim_total_paid) over (partition by ee_id_from_master) as Max_Claim_Tot_Paid,
SUM(ICD_BACK_SPINE) OVER (partition by ee_id_from_master) AS ICD_BACK_SPINE,
SUM(ICD_BLOOD_DISORDER) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_BLOOD_DISORDER,
SUM(ICD_BREAST_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_BREAST_DISEASE,
SUM(ICD_CIRCULATORY) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_CIRCULATORY,
SUM(ICD_CIRCUM_CAUSE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_CIRCUM_CAUSE,
SUM(ICD_CONGENITAL) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_CONGENITAL,
SUM(ICD_EAR_DISORDERS) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_EAR_DISORDERS,
SUM(ICD_ENDOCRINE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_ENDOCRINE,
SUM(ICD_EXTERNAL_CAUSE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_EXTERNAL_CAUSE,
SUM(ICD_EYE_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_EYE_DISEASE,
SUM(ICD_FRACTURES_SPRAINS) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_FRACTURES_SPRAINS,
SUM(ICD_GI) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_GI,
SUM(ICD_INFECTIOUS_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_INFECTIOUS_DISEASE,
SUM(ICD_MENTAL_SUBSTANCE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_MENTAL_SUBSTANCE,
SUM(ICD_MSK) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_MSK,
SUM(ICD_NEURO) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_NEURO,
SUM(ICD_ORAL_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_ORAL_DISEASE,
SUM(ICD_PELVIC_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_PELVIC_DISEASE,
SUM(ICD_PREGNANCY) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_PREGNANCY,
SUM(ICD_RENAL_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_RENAL_DISEASE,
SUM(ICD_RESPIRATORY_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_RESPIRATORY_DISEASE,
SUM(ICD_SKIN_DISEASE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_SKIN_DISEASE,
SUM(ICD_SYMPTOMS) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_SYMPTOMS,
SUM(ICD_TOXIC_EXPOSURE) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_TOXIC_EXPOSURE,
SUM(ICD_TRAUMA) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_TRAUMA,
SUM(ICD_TUMOR) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_TUMOR,
SUM(ICD_NULL) OVER (PARTITION BY EE_ID_FROM_MASTER) AS ICD_NULL,
max(max_total_app_days) over (partition by ee_id_from_master) as Max_Tot_App_Days,
max(max_rtw_date) over (partition by ee_id_from_master) as Max_RTW_Date,
max(max_rtw_date_restr) over (partition by ee_id_from_master) as Max_RTW_Date_Restricted,
case 
	when COMPSYCH_Ref > '1' then '1'
	else '0' end as ComPsych_Ref
FROM (
SELECT 
EE_ID_from_Master,
(File_Number),
date_disability_benefits_begin,
Coverage_Code,
Benefit_Plan_Description,
(DATEDIFF(day, date_disability_benefits_begin, date_disability_benefits_end)) as Duration,
max(claim_total_paid) as max_claim_total_paid,
max(Date_Hospitalized) as max_date_hosp,
max(date_last_worked) as max_date_lw,
CASE
	WHEN ICD_CODE_GROUP LIKE 'BACK%' THEN 1
	ELSE 0 END AS 'ICD_BACK_SPINE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'BLOOD%' THEN 1
	ELSE 0 END AS 'ICD_BLOOD_DISORDER',
CASE
	WHEN ICD_CODE_GROUP LIKE 'BREAST%' THEN 1
	ELSE 0 END AS 'ICD_BREAST_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'CIRCULA%' THEN 1
	ELSE 0 END AS 'ICD_CIRCULATORY',
CASE
	WHEN ICD_CODE_GROUP LIKE 'CIRCUMST%' THEN 1
	ELSE 0 END AS 'ICD_CIRCUM_CAUSE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'CONGENITAL%' THEN 1
	ELSE 0 END AS 'ICD_CONGENITAL',
CASE
	WHEN ICD_CODE_GROUP LIKE 'EAR%' THEN 1
	ELSE 0 END AS 'ICD_EAR_DISORDERS',
CASE
	WHEN ICD_CODE_GROUP LIKE 'ENDOCRINE%' THEN 1
	ELSE 0 END AS 'ICD_ENDOCRINE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'EXTERNAL%' THEN 1
	ELSE 0 END AS 'ICD_EXTERNAL_CAUSE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'EYE%' THEN 1
	ELSE 0 END AS 'ICD_EYE_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'FRACTURES%' THEN 1
	ELSE 0 END AS 'ICD_FRACTURES_SPRAINS',
CASE
	WHEN ICD_CODE_GROUP LIKE 'GASTRO%' THEN 1
	ELSE 0 END AS 'ICD_GI',
CASE
	WHEN ICD_CODE_GROUP LIKE 'INFECT%' THEN 1
	ELSE 0 END AS 'ICD_INFECTIOUS_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'MENTAL%' THEN 1
	ELSE 0 END AS 'ICD_MENTAL_SUBSTANCE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'MUSC%' THEN 1
	ELSE 0 END AS 'ICD_MSK',
CASE
	WHEN ICD_CODE_GROUP LIKE 'NEURO%' THEN 1
	ELSE 0 END AS 'ICD_NEURO',		
CASE
	WHEN ICD_CODE_GROUP LIKE 'ORAL%' THEN 1
	ELSE 0 END AS 'ICD_ORAL_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'PELVIC%' THEN 1
	ELSE 0 END AS 'ICD_PELVIC_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'PREGNANCY%' THEN 1
	ELSE 0 END AS 'ICD_PREGNANCY',
CASE
	WHEN ICD_CODE_GROUP LIKE 'RENAL%' THEN 1
	ELSE 0 END AS 'ICD_RENAL_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'RESP%' THEN 1
	ELSE 0 END AS 'ICD_RESPIRATORY_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'SKIN%' THEN 1
	ELSE 0 END AS 'ICD_SKIN_DISEASE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'SYMPTO%' THEN 1
	ELSE 0 END AS 'ICD_SYMPTOMS',
CASE
	WHEN ICD_CODE_GROUP LIKE 'TOXIC%' THEN 1
	ELSE 0 END AS 'ICD_TOXIC_EXPOSURE',
CASE
	WHEN ICD_CODE_GROUP LIKE 'TRAUMA%' THEN 1
	ELSE 0 END AS 'ICD_TRAUMA',
CASE
	WHEN ICD_CODE_GROUP LIKE 'TUMOR%' THEN 1
	ELSE 0 END AS 'ICD_TUMOR',
CASE 
	WHEN ICD_CODE_GROUP = 'NULL' THEN 1
	ELSE 0 END AS 'ICD_NULL',
max(total_approved_days) as max_total_app_days,
max(rtw_date_full) as max_rtw_date,
max(rtw_date_restricted) as max_rtw_date_restr,
case
	when Referred_To_ComPsych_MCF_081 > 0 THEN '1'
	Else '0' end AS COMPSYCH_Ref
FROM [dbo].[Sedgwick_Juris] as J
where Coverage_Code IN ('SD')
    and Claim_Sub_Status <> 'Denied'
    and Date_Disability_Benefits_Begin <> 'NULL'
    and Date_Disability_Benefits_Begin > '2017-12-31'
    and Date_Disability_Benefits_Begin < '2019-12-31'
   and ee_id_from_master NOT IN ('202000000000000','30193583887-0001',  '30193595858-0001', '30193585756-0001', '30193661310-0001', '30193357331-0001') 
    and Last_Updated_Date = (Select Max((Last_Updated_Date ))
    from [dbo].[Sedgwick_Juris] WHERE j.file_number = file_number) 
	group by ee_id_from_master, file_NUMBER, Coverage_Code, Benefit_Plan_Description, Date_Disability_Benefits_Begin, Date_Disability_Benefits_End, ICD_Code_Group, Referred_To_ComPsych_MCF_081) AS A
	GROUP BY EE_ID_FROM_MASTER,Coverage_Code,Benefit_Plan_Description,DURATION,max_claim_total_paid,
 max_date_hosp,
max_date_lw,
ICD_BACK_SPINE,
ICD_BLOOD_DISORDER,
ICD_BREAST_DISEASE,
ICD_CIRCULATORY,
ICD_CIRCUM_CAUSE,
ICD_CONGENITAL,
ICD_EAR_DISORDERS,
ICD_ENDOCRINE,
ICD_EXTERNAL_CAUSE,
ICD_EYE_DISEASE,
ICD_FRACTURES_SPRAINS,
ICD_GI,
ICD_INFECTIOUS_DISEASE,
ICD_MENTAL_SUBSTANCE,
ICD_MSK,
ICD_NEURO,		
ICD_ORAL_DISEASE,
ICD_PELVIC_DISEASE,
ICD_PREGNANCY,
ICD_RENAL_DISEASE,
ICD_RESPIRATORY_DISEASE,
ICD_SKIN_DISEASE,
ICD_SYMPTOMS,
ICD_TOXIC_EXPOSURE,
ICD_TRAUMA,
ICD_TUMOR,
ICD_NULL,
max_total_app_days,
max_rtw_date,
max_rtw_date_restr,COMPSYCH_Ref
ORDER BY EE_ID_FROM_MASTER;
